{% extends "layout.html" %}
{% block title %}Upload{% endblock %}

{{ super() }}

{% block content %}
    
    <style>
        .set{
            display:flex;
            flex-wrap: wrap;
            width:80vw;
            margin:0 auto;
        }
        .card{
            margin-top:5vh;
            width:40%;
            margin-left:10px;
        }
        .date-header{
            margin-top: 10vh;
        }
        .image{
            min-height: 100px;
        }
        .modal{
            height:100vh;
            width:100vw;
        }
        #modal-image{
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            margin: auto;
        }

    </style>

    <h2>History</h2>
    {% for date in dates %}
        <h3 class="date-header">{{date.strftime("%d %B %Y")}}</h3>
        <div class="set">
            {% for upload in uploads %}
                {% if upload.date == date %}
                        <div class="card">
                            <div class="card-image">
                                <img onclick="updateImage('{{upload.id}}')" class="image modal-trigger" data-target="modal-1" src="" data-id="{{upload.id}}">
                            </div>
                            <div class="card-content">
                                <p> Severity - {{upload.severity}} </p>
                                <p> Type - {{upload.disease_type}} </p>
                                <p> Actions - {{upload.actions}} </p>
                            </div>
                        </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}

    <div id="modal-1" class="modal">
        <div class="modal-content"> 
            <div style="display:flex">
                <button style="position:absolute; right:0; top:0;" class="btn-small material-icons modal-close"> X </button>
            </div>
            <img src="" id="modal-image">
        </div>
    </div>

        
    <script>
        const imageM = document.getElementById("modal-image")
        const uploads = document.querySelectorAll('[data-id]')
        uploads.forEach((upload) => {
            const uploadId = upload.getAttribute('data-id')
            fetch(`/api/uploadedImage/${uploadId}`)
            .then(response => response.json())
            .then(data => {
                if(data.error){
                    M.toast({'html' : data.error});
                    upload.src = "";
                }
                if(data.image){
                    upload.src = `data:image/jpeg;base64,${data.image}`;
                }
            });
        });

        function updateImage(updated){
            fetch(`/api/uploadedImage/${updated}`)
            .then(response => response.json())
            .then(data => {
                if(data.error){
                    M.toast({'html' : data.error});
                    imageM.src = "";
                }
                if(data.image){
                    imageM.src = `data:image/jpeg;base64,${data.image}`;
                }
            });
        }

    </script>
    


{% endblock %}