{% extends "layout.html" %}
{% block title %}Result{% endblock %}

{{ super() }}

{% block content %}
    
    <style>
        body{
            overflow-x: hidden;
            padding:0;
            margin:0;
        }
        .container{
            background-color: #24374f;
            background-size: cover;
            color:white;
            min-height:100vh;
            height:auto;
            width:100vw;
        }
        #uploaded-image{
            display:flex;
            margin:0 auto;
            max-height:50vh;
            max-width:80vw;
            object-fit: contain;
        }
        #results{
            display:flex;
            flex-direction: column;
            justify-content: center;
            align-items:center;
        }
        #results h5{
            font-weight: bold;
            justify-self: center;
        }
        #results p{
            justify-self: center;
        }
        blockquote{
            margin-top: 5svh;
            margin-left: 5px;
        }
        #icons{
            margin-top: 10px;
            margin-left: 5px;
            display:inline-flex;
        }
        .scroller{
            cursor: pointer; 
            font-size: 50px; 
        }
        .scroller:hover{
            background-color: white;
            color:black;
            border-radius: 100%;
        }
        #back-to-upload{
            display: inline-flex;
        }
        #header{
            display:flex;
            justify-content:center;
        }
        .imageSection{
            width:100vw;
            min-height:100dvh;
            height:auto;
            background-color: #3c6a50;
            color:white;
        }
        .imageSection h2{
            margin-top: 0;
        }
        .imageSection p{
            display: flex;
            justify-content: center;
        }
        #switch-btns{
            display:flex;
            justify-content:center;
        }
        #show-weather{
            display:none;
        }
        #show-analysis{
            display:none;
        }
        #weather{
            display:none;
            justify-content: center;
            flex-wrap: wrap;
            gap:15px;
        }
        .day{
            background-color: transparent;
            color:white;
            padding:10px;
            text-align:center;
            min-width: 10vw;
            border: 1px dotted grey;
        }
        
    </style>
    
    <div class="container">
        {% if upload %}
        <div style="display:flex">
            <div id="icons">
                <a id="back-to-upload" class="btn" href="/upload-page"> <i class="material-icons">keyboard_backspace</i> Back to upload</a>
            </div>
            <i style="margin-left: auto; margin-right: 1vw;" onclick="scrollDown()" class="material-symbols-outlined scroller">arrow_circle_down</i>
        </div>
        <div id="header">
            <h2 style="margin:auto;">Results: </h2>
        </div>
        <blockquote>Scroll to see the uploaded image</blockquote>
        <div id="results" class="animate__animated animate__fadeIn">

            <h5> Disease type: </h5>
            <p>{{upload.disease_type}}</p>
            <h5> Severity: </h5>
            <p>{{upload.severity}} %</p>
            <h5> Remedial Actions: </h5>
            <p>{{upload.actions}}</p>
            
        </div>
        <div id="weather" class="animate__animated animate__fadeIn">
            <div class="day card">
                
            </div>
            <div class="day card">

            </div>
            <div class="day card">

            </div>
        </div>
        <div id="switch-btns">
            <button id="show-weather" class="btn" onclick="showWeather()"> View Weather Report </button>
            <button id="show-analysis" class="btn" onclick="showAnalysis()"> View Analysis </button>
        </div>

        {% else %}
        <div>
            <h2>Error </h2>
            <p>Error displaying results</p>
            <a class="btn" href="/"> Go Home </a>
        </div>
        {% endif %}
    </div>

    {% if upload %}
    <div class="imageSection">
        <i style="cursor: pointer; font-size: 50px;"onclick="backToTop()" class="material-symbols-outlined scroller">arrow_circle_up</i>

        <div style="text-align: center;">
            <h2>Upload</h2>
        </div>
        <div style="margin-top: 10svh;">
        <p id="date">{{upload.date}}</p>
        {% if is_authenticated %}
            <p>Upload ID - {{upload.id}}</p>
        {% else %}
            <p>Upload ID - Must be logged in</p>
        {% endif %}
        </div>
        {% if image %}
            <img id="uploaded-image" src="{{image}}" class="uploadImage">
        {% endif %}
    </div>
    {% endif %}


    <script>
        const dateElement = document.getElementById("date")
        const dateWithTime = dateElement.innerText
        let dateExtract = new Date(dateWithTime);
        dateElement.innerText = `Date - ${dateExtract.toISOString().split('T')[0]}`;

        const confettiConfig = {
            particleCount:100
        }
        window.onload = function() {
            confetti(confettiConfig);
        }

        function backToTop(){
            window.scrollTo({
                top: 0,
                left: 0,
                behavior: "smooth",
            });
        }
        function scrollDown() {
            window.scrollTo({
                top: document.body.scrollHeight,
                left: 0,
                behavior: "smooth"
            });
        }

    </script>


    <script>
        const weatherBtn = document.getElementById("show-weather");
        const weather = document.getElementById("weather");
        const analysisBtn = document.getElementById("show-analysis");
        const results = document.getElementById("results");
        const days = document.querySelectorAll(".day")

        fetch("https://api.ipgeolocation.io/getip")
        .then(response => response.json())
        .then(data => {
            if(data.ip){
                get_geoLocation(data.ip)
                weatherBtn.style.display = "flex";

            }
        });

        function get_geoLocation(address){
            fetch(`/api/get-weather/${address}`)
                .then(response => response.json())
                .then(data => {
                    if(data.days){
                        weatherBtn.style.display = "flex";
                        days[0].innerHTML = `<b>${data.days[0].day} </b> 
                                             <p>${data.days[0].weather} </p>
                                             <p>${data.days[0].temperature} °C</p>`;
                        days[1].innerHTML = `<b>${data.days[1].day} </b> 
                                             <p>${data.days[1].weather} </p>
                                             <p>${data.days[1].temperature} °C</p>`
                        days[2].innerHTML = `<b>${data.days[2].day} </b> 
                                             <p>${data.days[2].weather} </p>
                                             <p>${data.days[2].temperature} °C</p>`
                    }
                });
        }

        function showWeather(){
            weatherBtn.style.display = "none";
            analysisBtn.style.display = "flex";
            results.style.display = "none";
            weather.style.display = "flex";

        }

        function showAnalysis(){
            weatherBtn.style.display = "flex";
            analysisBtn.style.display = "none";
            weather.style.display = "none";
            results.style.display = "flex";
        }
        
        
    </script>

{% endblock %}